/*******************************************************************************
*  skI2Clib - ？h？Q？b？？？？？？？C？u？？？？                                             *
*             ？？？？？？？C？u？？？？？？I2C？f？o？C？X(RTC/EEPROM？？)？？？？？？？？？s？？？？？？？？？？？W  *
*                                                                              *
*    InterI2C       - ？h？Q？b？？？A？？？？？？？？？？？？？？                                 *
*    InitI2C_Master - ？h？Q？b？？？M？？？}？X？^？[？？？[？h？？？？？？？？？？？s？？？？？？             *
*    I2C_Start      - ？X？？？[？u？？？X？^？[？g？R？？？f？B？V？？？？？？？？？s？？？？？？？？           *
*    I2C_rStart     - ？X？？？[？u？？？？？s？[？g？E？X？^？[？g？R？？？f？B？V？？？？？？？？？s？？？？？？？？ *
*    I2C_Stop       - ？X？？？[？u？？？X？g？b？v？R？？？f？B？V？？？？？？？？？s？？？？？？？？           *
*    I2C_Send       - ？X？？？[？u？？？f？[？^？？？P？o？C？g？？？M？？？？？？？？                   *
*    I2C_Receive    - ？X？？？[？u？？？？？f？[？^？？？P？o？C？g？？？M？？？？？？？？                 *
*                                                                              *
*    ？？？？？FSDA/SCL？s？？？？？K？？？u？f？W？^？？？？？？？s？？？v？？？？？？？？？s？？？？？？？？？？？B         *
*          ？？？M？N？？？b？N？？100/400KHz(CPU8MHz)？？？？？？？？？？？？？？？B                  *
*          ？}？？？`？}？X？^？[？？？？？o？X？？？？？？？？？？？？？？？？？？？？？A"I2C_Start"？？？？？？？？？？？？ *
*          SSP2？？？？？p？？？？？？？？？？？AskI2Clib.h？？"#define I2C_MSSP2_USE"？？？？？？？？？？ *
* ============================================================================ *
*  VERSION DATE        BY                    CHANGE/COMMENT                    *
* ---------------------------------------------------------------------------- *
*  1.00    2012-01-20  ？？？？？？？H？[(？？？？？？？？)  Create                            *
*  1.01    2013-02-16  ？？？？？？？H？[(？？？？？？？？)  XC8 C Compiler ？？？？？？？？？X         *
*  2.00    2014-11-01  ？？？？？？？H？[(？？？？？？？？)  ？}？？？`？}？X？^？[？？？？？？              *
*  2.10    2015-03-04  ？？？？？？？H？[(？？？？？？？？)  ？？？？？？？？100/400KHz？w？？？？？？？？？X    *
*  3.00    2015-04-20  ？？？？？？？H？[(？？？？？？？？)  SSP1/SSP2？？？？？？16F193x？？？？？？      *
*  3.01    2015-07-19  ？？？？？？？H？[(？？？？？？？？)  ？R？？？？？g？？？？                      *
* ============================================================================ *
*  PIC 12F1822 16F18xx 16F193x 18F25K22 18F26J50                               *
*  MPLAB IDE(V8.63) MPLAB X(v2.15)                                             *
*  MPLAB(R) XC8 C Compiler Version 1.00/1.32                                   *
*******************************************************************************/
#include <xc.h>
#include "skI2Clib.h"

int AckCheck ;           // ？？？？？？？？？？ACK？？？？？p？t？？？O？？？？
int CollisionCheck ;     // ？？？？？}？X？^？[？？？？？o？X？？？？？？？o？p？t？？？O？？？？

// ？A？C？h？？？？？？？？？`？F？b？N
// ACKEN RCEN PEN RSEN SEN R/W BF ？？？S？？？O？？？？？n？j
void I2C_IdleCheck(char mask)
{
     while (( I2C_SSPCON2 & 0x1F ) | (I2C_SSPSTAT & mask)) ;
}
/*******************************************************************************
*  InterI2C( void )                                                            *
*    ？h？Q？b(？}？X？^？[？？？[？h)？？？A？？？？？？？？？？？？？？                                  *
*     ？？？？？？？？？？？？？C？？？v？？？O？？？？？？？？？？？？？？？？？？？？？？？？？？                         *
*******************************************************************************/
/*void InterI2C( void )
{
     if (I2C_SSPIF == 1) {       // SSP(I2C)？？？？？？？？？？？？？？？H
          if (AckCheck == 1) AckCheck = 0 ;
          I2C_SSPIF = 0 ;        // ？t？？？O？N？？？A
     }
     if (I2C_BCLIF == 1) {       // MSSP(I2C)？o？X？？？？？？？？？？？？？？？？？？？H
          CollisionCheck = 1 ;
          I2C_BCLIF = 0 ;        // ？t？？？O？N？？？A
     }
}*/
/*******************************************************************************
*  InitI2C_Master(speed)                                                       *
*    ？h？Q？b？？？M？？？}？X？^？[？？？[？h？？？？？？？？？？？s？？？？？？                              *
*                                                                              *
*    speed : I2C？？？？？M？？？x？？？w？？(0=100KHz 1=400KHz)                            *
*                                                                              *
*    ？？)？N？？？b？N8MHz？？？？？？？？？？？？？A？？？？？N？？？b？N？？SSPADD？？？？？X？？？？？K？v？？？L？？？？？？ *
*             4MHz  8MHz  16MHz  32MHz  40MHz  48MHz  64MHz                    *
*    100KHz   0x09  0x13   0x27   0x4F   0x63   0x77   0x9F                    *
*    400kHz         0x04   0x09   0x13   0x18   0x1D   0x27                    *
*    400KHz？？？？？？？？？？250KHz？？？？？？？？？x？？？o？？？？？？？？？？？？？A100KHz？？？？？？？？？？？？？x？？？？*
*    ？？？l？？？？？？？？？？？？？？？？？？？？？x？？？？？？？？？？？？？？？？？v？Z？？？x？？？？？？？？？？？？？B          * 
*******************************************************************************/
/*void InitI2C_Master(int speed)
{
     I2C_SSPSTAT= 0b10000000 ;     // ？W？？？？？x？？？[？h(？X？？？[？？？[？g？？？？OFF)？？？？？？？？？？(100kHz/1MHz)
     I2C_SSPCON1= 0b00101000 ;     // SDA/SCL？s？？？？I2C？？？g？p？？？A？}？X？^？[？？？[？h？？？？？？
     if (speed == 0) {
          I2C_SSPADD = 0x4F  ;     // ？N？？？b？N=FOSC/((SSPADD + 1)*4) 8MHz/((0x13+1)*4)=0.1(100KHz)
     } else {
          I2C_SSPADD = 0x13  ;     // ？N？？？b？N=FOSC/((SSPADD + 1)*4) 8MHz/((0x04+1)*4)=0.4(400KHz)
          I2C_SSPSTAT_SMP = 0 ;    // ？？？？？？？x？？？[？h(？X？？？[？？？[？g？？？？ON)？？？？？？？？？？(400kHz)
     }
     I2C_SSPIE = 1 ;               // SSP(I2C)？？？？？？？？？？？？？？？？？？
     I2C_BCLIE = 1 ;               // MSSP(I2C)？o？X？？？？？？？？？？？？？？？？？？？？？？
     PEIE      = 1 ;               // ？？？？？？？u？？？？？？？？？？？？？？？？？？
     GIE       = 1 ;               // ？S？？？？？？？？？？？？？？？？？？？？？？ 
     I2C_SSPIF = 0 ;               // SSP(I2C)？？？？？？？？？t？？？O？？？N？？？A？？？？
     I2C_BCLIF = 0 ;               // MSSP(I2C)？o？X？？？？？？？？？？？？？t？？？O？？？N？？？A？？？？
}*/
/*******************************************************************************
*  ans = I2C_Start(adrs,rw)                                                    *
*    ？X？？？[？u？？？X？^？[？g？R？？？f？B？V？？？？？？？？？s？？？？？？？？                            *
*                                                                              *
*    adrs : ？X？？？[？u？？？A？h？？？X？？？w？？？？？？？？                                     *
*    rw   : ？X？？？[？u？？？？？？？？？？？？？？？w？？？？？？？？？？                                 *
*           0=？X？？？[？u？？？？？？？？？？？？？？？v？？？@1=？X？？？[？u？？？？？M？？？？？？？？？v？？         *
*    ans  : 0=？？？？                                                             *
*           1=？？？？(？？？？？？？？ACK？？？？？？？？？？？？？？) -1=？？？？？}？X？^？[？？？？？o？X？？？？？？？？  *
*******************************************************************************/
int I2C_Start(int adrs,int rw)
{
     CollisionCheck = 0 ;
     // ？X？^？[？g(START CONDITION)
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_SEN = 1 ;
     // [？X？？？[？u？？？A？h？？？X]？？？？？M？？？？
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     AckCheck = 1 ;
     I2C_SSPBUF = (char)((adrs<<1)+rw) ;     // ？A？h？？？X + R/W？？？？？M
     while (AckCheck) ;                      // ？？？？？？？？？？ACK？？？？？？？？？？
     if (CollisionCheck == 1) return -1 ;
     return I2C_SSPCON2_ACKSTAT ;
}
/*******************************************************************************
*  ans = I2C_rStart(adrs,rw)                                                   *
*    ？X？？？[？u？？？？？s？[？g？E？X？^？[？g？R？？？f？B？V？？？？？？？？？s？？？？？？？？                  *
*                                                                              *
*    adrs : ？X？？？[？u？？？A？h？？？X？？？w？？？？？？？？                                     *
*    rw   : ？X？？？[？u？？？？？？？？？？？？？？？w？？？？？？？？？？                                 *
*           0=？X？？？[？u？？？？？？？？？？？？？？？v？？？@1=？X？？？[？u？？？？？M？？？？？？？？？v？？         *
*    ans  : 0=？？？？                                                             *
*           1=？？？？(？？？？？？？？ACK？？？？？？？？？？？？？？) -1=？？？？？}？X？^？[？？？？？o？X？？？？？？？？  *
*******************************************************************************/
int I2C_rStart(int adrs,int rw)
{
     CollisionCheck = 0 ;
     // ？？？s？[？g？E？X？^？[？g(REPEATED START CONDITION)
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_RSEN = 1 ;
     // [？X？？？[？u？？？A？h？？？X]？？？？？M？？？？
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     AckCheck = 1 ;
     I2C_SSPBUF = (char)((adrs<<1)+rw) ;     // ？A？h？？？X + R/W？？？？？M
     while (AckCheck) ;                      // ？？？？？？？？？？ACK？？？？？？？？？？
     if (CollisionCheck == 1) return -1 ;
     return I2C_SSPCON2_ACKSTAT ;
}
/*******************************************************************************
*  ans = I2C_Stop()                                                            *
*    ？X？？？[？u？？？X？g？b？v？R？？？f？B？V？？？？？？？？？s？？？？？？？？                            *
*    ans  :  0=？？？？                                                            *
*           -1=？？？？？}？X？^？[？？？？？o？X？？？？？？？？                                    *
*******************************************************************************/
int I2C_Stop()
{
     CollisionCheck = 0 ;
     // ？X？g？b？v(STOP CONDITION)
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_PEN = 1 ;
     if (CollisionCheck == 1) return -1 ;
     else                     return  0 ;
}
/*******************************************************************************
*  ans = I2C_Send(dt)                                                          *
*    ？X？？？[？u？？？f？[？^？？？P？o？C？g？？？M？？？？？？？？                                    *
*                                                                              *
*    dt  : ？？？M？？？？？f？[？^？？？w？？？？？？？？                                          *
*    ans  : 0=？？？？                                                             *
*           1=？？？？(？？？？？？？？ACK？？？？？？？？？？？？？？？？？？NOACK？？？？？？？？)                 *
*          -1=？？？？？}？X？^？[？？？？？o？X？？？？？？？？                                     *
*******************************************************************************/
int I2C_Send(char dt)
{
     CollisionCheck = 0 ;
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     AckCheck = 1 ;
     I2C_SSPBUF = dt ;                  // ？f？[？^？？？？？M
     while (AckCheck) ;                 // ？？？？？？？？？？ACK？？？？？？？？？？
     if (CollisionCheck == 1) return -1 ;
     return I2C_SSPCON2_ACKSTAT ;
}
/*******************************************************************************
*  ans = I2C_Receive(ack)                                                      *
*    ？X？？？[？u？？？？？f？[？^？？？P？o？C？g？？？M？？？？？？？？                                  *
*                                                                              *
*    ack  : ？X？？？[？u？？？？？？？？？f？[？^？？？w？？？？？？？？                                 *
*           0:ACK？？？？？？？@1:NOACK？？？？？？(？？？M？f？[？^？？？？？？？？？？1)                  *
*    ans  : ？？？M？？？？？f？[？^？？？？？？                                               *
*           -1=？？？？？}？X？^？[？？？？？o？X？？？？？？？？                                    *
*******************************************************************************/
int I2C_Receive(int ack)
{
     int dt ;

     CollisionCheck = 0 ;
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_RCEN = 1 ;           // ？？？M？？？？？？？？？？
     I2C_IdleCheck(0x4) ;
     if (CollisionCheck == 1) return -1 ;
     dt = I2C_SSPBUF ;                // ？f？[？^？？？？？M
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     I2C_SSPCON2_ACKDT = ack ;        // ACK？f？[？^？？？Z？b？g
     I2C_SSPCON2_ACKEN = 1 ;          // ACK？f？[？^？？？？？？
     return dt ;
}
